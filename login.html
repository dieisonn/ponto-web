<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ponto • Entrar</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#4b4bd6">
  <link rel="icon" href="favicon.ico">
  <style>
    :root{ --brand:#4b4bd6; --ink:#1f2330; --mut:#6b7280; --card:#fff; --bg:#f6f7fb; --bd:#e6e8ef; }
    *{box-sizing:border-box}
    body{margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink);}
    .wrap{min-height:100dvh; display:grid; place-items:center; padding:24px;}
    .panel{width:min(560px,94vw); background:var(--card); border:1px solid var(--bd); border-radius:16px; padding:28px; box-shadow:0 10px 30px rgba(40,48,80,.06);}
    h1{margin:0 0 4px; font-size:28px;}
    p.small{color:var(--mut); margin:0 0 22px;}
    label{font-weight:600; display:block; margin:10px 0 6px;}
    input[type=email],input[type=password]{width:100%; border:1px solid var(--bd); border-radius:10px; padding:12px; font:inherit; background:#fff;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;}
    .btn{padding:12px 16px; border-radius:10px; border:1px solid var(--bd); background:#fff; cursor:pointer; font-weight:600;}
    .btn.brand{background:var(--brand); border-color:var(--brand); color:#fff;}
    .btn.link{background:transparent;}
    .foot{display:flex; justify-content:space-between; align-items:center; margin-top:18px; color:var(--mut); font-size:13px}
    .brand{display:flex; align-items:center; gap:10px; margin-bottom:16px}
    .badge{background:rgba(75,75,214,.08); color:#2b2bd8; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700}
    .lang{margin-left:auto; border:1px solid var(--bd); border-radius:10px; padding:6px 8px; font:inherit}
    .tip{font-size:13px; color:var(--mut); margin-top:12px; min-height:1.2em}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="brand">
        <img src="icon-192.png" alt="" width="28" height="28" style="border-radius:6px">
        <div style="font-weight:800; font-size:18px;">Ponto</div>
        <span class="badge">beta</span>
        <select id="lang" class="lang"><option value="pt" selected>pt</option><option value="en">en</option><option value="es">es</option></select>
      </div>

      <h1>Bem-vindo(a)</h1>
      <p class="small">Entre com seu e-mail e senha para registrar sua jornada.</p>

      <label for="email">E-mail</label>
      <input id="email" type="email" placeholder="voce@empresa.com" autocomplete="username" required>

      <label for="pass">Senha</label>
      <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password" required>

      <div class="row">
        <button id="btnLogin" class="btn brand">Entrar</button>
        <button id="btnReset" class="btn">Esqueci a senha</button>
        <button id="btnSignup" class="btn link">Criar conta</button>
      </div>

      <p id="status" class="tip"></p>

      <div class="foot">
        <label><input id="install" type="checkbox"> instalar como app</label>
        <span>© <script>document.write(new Date().getFullYear())</script></span>
      </div>
    </div>
  </div>

<script type="module">
  import { initApp, auth, ensureRoleDoc, isAdmin } from './app.js';
  await initApp();

  // PWA
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  }
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; });
  document.getElementById('install').onchange=async ev=>{ if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; } ev.target.checked=false; };

  const $=id=>document.getElementById(id);
  const setMsg=m=>{ $('status').textContent=m||''; };

  const m=await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
  const ALLOW_SIGNUP=true; // coloque false se não quiser auto-cadastro

  async function afterLogin(user){
    await ensureRoleDoc(user.uid, user.displayName || (user.email? user.email.split('@')[0] : ''), user.email || '');
    const admin = await isAdmin(user.uid);
    // mapeamento correto: admin -> admin.html | user -> index.html
    location.replace(admin ? 'admin.html' : 'index.html');
  }
  function showErr(e){
    let msg=e?.code||e?.message||String(e);
    if(e?.code==='auth/invalid-credential'||e?.code==='auth/wrong-password') msg='E-mail ou senha inválidos.';
    if(e?.code==='auth/user-not-found') msg='Usuário não encontrado.';
    if(e?.code==='auth/too-many-requests') msg='Muitas tentativas. Tente novamente em alguns minutos.';
    if(e?.code==='auth/operation-not-allowed') msg='Método de login não habilitado (email/senha).';
    setMsg('Erro: '+msg);
  }

  $('btnLogin').onclick=async()=>{
    try{
      setMsg('Autenticando...');
      const cred=await m.signInWithEmailAndPassword(auth,$('email').value.trim(),$('pass').value);
      await afterLogin(cred.user);
    }catch(e){ showErr(e); }
  };
  $('btnReset').onclick=async()=>{
    const email=$('email').value.trim(); if(!email) return setMsg('Informe seu e-mail para receber o link.');
    try{ await m.sendPasswordResetEmail(auth,email); setMsg('Enviamos um link para redefinir sua senha.'); }
    catch(e){ showErr(e); }
  };
  $('btnSignup').onclick=async()=>{
    if(!ALLOW_SIGNUP){ alert('Criação de conta desativada.'); return; }
    try{
      setMsg('Criando conta...');
      const cred=await m.createUserWithEmailAndPassword(auth,$('email').value.trim(),$('pass').value);
      try{ await m.updateProfile(cred.user,{ displayName:$('email').value.split('@')[0] }); }catch{}
      await afterLogin(cred.user);
    }catch(e){ showErr(e); }
  };

  // se já estiver logado, despacha
  m.onAuthStateChanged(auth,(u)=>{ if(u) afterLogin(u); });
</script>
</body>
</html>
