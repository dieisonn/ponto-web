<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marcação de Ponto</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 760px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input,select,button,textarea { padding: 9px 12px; border-radius:10px; border:1px solid #ccc; }
    input,select,textarea { width:100%; }
    button { cursor:pointer; }
    .muted { color:#666; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>Marcação de Ponto <small id="badgeQueue" class="muted"></small></h1>

  <!-- ===== deslogado ===== -->
  <div id="loggedOut" class="card">
    <h3>Entrar</h3>
    <label>Email</label>
    <input id="email" type="email" />
    <label>Senha</label>
    <input id="password" type="password" />
    <div class="row">
      <button id="btnLogin">Login</button>
      <button id="btnRegister">Criar conta</button>
    </div>
    <p id="msg" style="color:#b00020;"></p>
  </div>

  <!-- ===== logado ===== -->
  <div id="loggedIn" class="card hidden">
    <p>Olá, <b id="who"></b></p>

    <div class="card">
      <h3>Bater ponto</h3>
      <div class="row">
        <label style="flex:1">Data:
          <input id="pDate" type="date">
        </label>
        <label style="flex:1">Hora:
          <input id="pTime" type="time" step="60">
        </label>
        <div style="flex:1; align-self:flex-end">Tipo (detectado):
          <b id="typeDetected">-</b>
        </div>
      </div>
      <label>Motivo/Observação</label>
      <input id="note" placeholder="Opcional" />
      <div class="row" style="margin-top:8px">
        <button id="btnPunch">Registrar</button>
        <button id="btnSync" type="button">Sincronizar fila</button>
        <button id="btnLogout" style="margin-left:auto">Sair</button>
      </div>
      <p id="status" class="muted"></p>
      <small class="muted">Se estiver sem internet, o ponto fica na fila e sincroniza quando a conexão voltar.</small>
    </div>

    <p id="dailyTotal" class="muted"></p>

    <div class="card">
      <h3>Registros de hoje</h3>
      <ul id="listToday"></ul>
    </div>

    <div class="card">
      <h3>Último registro</h3>
      <ul id="lastList"></ul>
      <div class="row">
        <button id="btnAdjFromLast">Ajustar este ponto…</button>
        <button id="btnReqDelete">Pedir exclusão deste ponto…</button>
      </div>
    </div>

    <div class="card">
      <h3>Solicitar ajuste</h3>
      <div class="row">
        <label>Data: <input id="adjDate" type="date"></label>
        <label>Hora: <input id="adjTime" type="time" step="60"></label>
        <label>Tipo:
          <select id="adjType">
            <option value="entrada">Entrada</option>
            <option value="saida">Saída</option>
          </select>
        </label>
      </div>
      <label>Motivo</label>
      <input id="adjReason" placeholder="Explique o ajuste..." />
      <button id="btnAdjSend">Enviar pedido</button>
      <p id="adjMsg" class="muted"></p>
    </div>

    <p><a href="admin.html" id="adminLink" class="hidden">Ir ao painel do Admin</a></p>
  </div>

  <script type="module">
    import {
      initApp, auth, onUserChanged, ensureRoleDoc, isAdmin, getProfile,
      addPunch, nextTypeFor, listRecentPunchesRaw, listPunchesByDayForUser,
      computeDailyMs, msToHHMM, requestAdjustment, flushQueue, getQueueSize
    } from './app.js';

    await initApp();

    const $ = id => document.getElementById(id);
    const show = (el, v) => el.classList.toggle('hidden', !v);
    function setNow() {
      const now = new Date();
      $('pDate').value = now.toISOString().slice(0,10);
      $('pTime').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    }

    // ===== login
    $('btnLogin').onclick = async () => {
      $('msg').textContent = '';
      try {
        const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
        await m.signInWithEmailAndPassword(auth, $('email').value, $('password').value);
      } catch (e) { $('msg').textContent = e.message || String(e); }
    };
    $('btnRegister').onclick = async () => {
      $('msg').textContent = '';
      try {
        const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
        const cred = await m.createUserWithEmailAndPassword(auth, $('email').value, $('password').value);
        await ensureRoleDoc(cred.user.uid);
      } catch (e) { $('msg').textContent = e.message || String(e); }
    };
    $('btnLogout').onclick = async () => {
      const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
      await m.signOut(auth);
      location.reload();
    };

    function renderQueueBadge() {
      const n = getQueueSize();
      $('badgeQueue').textContent = n ? `(${n} pend.)` : '';
    }

    // ===== UI punch
    async function refreshDetectedType() {
      if (!auth.currentUser) return;
      const t = await nextTypeFor(auth.currentUser.uid);
      $('typeDetected').textContent = t === 'entrada' ? 'Entrada' : 'Saída';
      $('btnPunch').textContent   = 'Registrar ' + (t === 'entrada' ? 'Entrada' : 'Saída');
    }

    async function refreshToday() {
      if (!auth.currentUser) return;
      const day = new Date().toISOString().slice(0,10);
      const rows = await listPunchesByDayForUser(auth.currentUser.uid, day);
      const ul = $('listToday'); ul.innerHTML = '';
      if (!rows.length) {
        const li = document.createElement('li'); li.textContent = 'Nenhum registro hoje.'; ul.appendChild(li);
      } else {
        rows.forEach(r => {
          const dt = r.at?.toDate ? r.at.toDate() : (r.ts?.toDate ? r.ts.toDate() : new Date());
          const li = document.createElement('li');
          li.textContent = `${dt.toLocaleString('pt-BR')} (${r.type})${r.note ? ' — '+r.note : ''}`;
          ul.appendChild(li);
        });
      }
      $('dailyTotal').textContent = 'Total de horas hoje: ' + msToHHMM(computeDailyMs(rows));
    }

    async function refreshLast() {
      const list = await listRecentPunchesRaw(1);
      const ul = $('lastList'); ul.innerHTML = '';
      if (!list.length) { const li=document.createElement('li'); li.textContent='Sem registros.'; ul.appendChild(li); return; }
      const d = list[0];
      const when = d.at?.toDate ? d.at.toDate() : (d.ts?.toDate ? d.ts.toDate() : new Date());
      const li = document.createElement('li');
      li.textContent = `${when.toLocaleString('pt-BR')} (${d.type})${d.note ? ' — '+d.note : ''}`;
      ul.appendChild(li);

      // preparar ajuste rápido
      $('btnAdjFromLast').onclick = () => {
        $('adjDate').value = when.toISOString().slice(0,10);
        $('adjTime').value = `${String(when.getHours()).padStart(2,'0')}:${String(when.getMinutes()).padStart(2,'0')}`;
        $('adjType').value = d.type || 'entrada';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      };
      $('btnReqDelete').onclick = async () => {
        const reason = prompt('Explique por que deseja excluir este ponto:') || '';
        await requestAdjustment({ action:'delete', targetPath: d._path, type: d.type, reason });
        alert('Pedido enviado.');
      };
    }

    $('btnPunch').onclick = async () => {
      $('status').textContent = 'Registrando...';
      try {
        const [Y,M,D] = $('pDate').value.split('-').map(n=>parseInt(n,10));
        const [h,m]   = $('pTime').value.split(':').map(n=>parseInt(n,10));
        const at = new Date(Y, (M-1), D, h, m, 0, 0);
        const res = await addPunch($('note').value || '', at, null); // tipo auto
        $('note').value = '';
        $('status').textContent = `Ponto registrado! (${res.type})`;
        await refreshDetectedType();
        await refreshToday();
        await refreshLast();
      } catch (e) {
        $('status').textContent = e.message || String(e);
      } finally {
        renderQueueBadge();
      }
    };

    $('btnSync').onclick = async () => {
      $('status').textContent = 'Sincronizando fila...';
      try {
        const r = await flushQueue();
        $('status').textContent = `Sincronizado: ${r.synced}. Pendentes: ${r.pending}.`;
        await refreshDetectedType();
        await refreshToday();
        await refreshLast();
      } catch (e) {
        $('status').textContent = e.message || String(e);
      } finally {
        renderQueueBadge();
      }
    };

    // ajuste manual
    $('btnAdjSend').onclick = async () => {
      try {
        await requestAdjustment({
          dateISO: $('adjDate').value,
          timeHHMM: $('adjTime').value,
          type: $('adjType').value,
          reason: $('adjReason').value || ''
        });
        $('adjMsg').textContent = 'Pedido enviado. Aguarde aprovação.';
        $('adjReason').value = '';
      } catch (e) { $('adjMsg').textContent = e.message || String(e); }
    };

    // ciclo de login
    onUserChanged(async (user) => {
      renderQueueBadge();
      show($('loggedOut'), !user);
      show($('loggedIn'), !!user);
      $('msg').textContent = '';
      $('status').textContent = '';
      if (!user) return;

      // nome amigável
      const prof = await getProfile(user.uid);
      $('who').textContent = prof?.name ? prof.name : (user.email || '');

      setNow();
      await ensureRoleDoc(user.uid);
      await refreshDetectedType();
      await refreshToday();
      await refreshLast();

      const admin = await isAdmin(user.uid);
      show($('adminLink'), admin);
    });
  </script>
</body>
</html>
