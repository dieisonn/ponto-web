<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="manifest" href="manifest.webmanifest">
  <title>Painel Admin - Ponto</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --brand:#4b4bd6; --brand-600:#4646cc; --brand-400:#7575e6;
      --ink:#1f2430; --mut:#637085;
      --bg:#f6f7fb; --card:#fff; --bd:#e6e8f0;
      --ok:#1b7a3b; --warn:#7a5a00; --bad:#b11;
    }
    [data-theme="dark"]{
      --bg:#0f1220; --card:#14172a; --ink:#e9ecff; --mut:#a7b0ca; --bd:#262a44;
    }
    html,body{ background:var(--bg); color:var(--ink); }
    body{ font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width:1100px; margin:24px auto; padding:0 12px; }
    h1{ margin:0 0 16px; }
    a{ color:var(--brand); text-decoration:none }
    a:hover{ text-decoration:underline }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:14px; padding:16px; margin:12px 0; box-shadow:0 2px 6px rgba(0,0,0,.05) }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    input,select,button{ font-size:15px }
    input[type=date],input[type=month],input[type=text],select{
      border:1px solid var(--bd); border-radius:10px; padding:8px 10px; background:#fff
    }
    [data-theme="dark"] input,[data-theme="dark"] select{ background:#0f1122; color:var(--ink); border-color:#2a2f55 }
    button{ padding:10px 14px; border-radius:10px; border:1px solid var(--bd); background:#fff; cursor:pointer; transition:transform .06s ease }
    button:active{ transform:scale(0.98) }
    button.primary{ background:var(--brand); color:#fff; border-color:var(--brand) }
    button.primary:hover{ background:var(--brand-600); border-color:var(--brand-600) }
    button.ghost{ color:var(--brand); border-color:var(--brand-400); background:#eef0ff }
    button.danger{ color:#fff; background:#d9534f; border-color:#d9534f }
    table{ width:100%; border-collapse:collapse }
    th,td{ border:1px solid var(--bd); padding:8px 10px; text-align:left }
    th{ background:#fafbff }
    [data-theme="dark"] th{ background:#1a1e36 }
    .muted{ color:var(--mut) }
    .hidden{ display:none }
    .right{ margin-left:auto }
    .pill{ display:inline-block; background:#eef0ff; color:var(--brand); border:1px solid var(--brand-400); border-radius:999px; padding:2px 8px; font-size:12px }
    .warn{ background:#fff8e1; border-color:#ffe49c; color:var(--warn) }
    .bad{ background:#ffecec; border-color:#ffd2d2; color:var(--bad) }
    .grid{ display:grid; gap:6px }
    .heat{ display:grid; grid-template-columns: 140px repeat(7, 1fr); gap:6px; align-items:center }
    .heat .cell{ height:16px; border-radius:4px; }
    .c-ok{ background:#b5f5c0 }
    .c-late{ background:#ffe49c }
    .c-abs{ background:#ffb3b3 }
  </style>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="row" style="justify-content:space-between;align-items:center">
    <h1>Painel do Administrador</h1>
    <div class="row">
      <button id="btnTheme" class="ghost">üåì Tema</button>
      <select id="langSel"><option value="pt">pt</option><option value="en">en</option></select>
    </div>
  </div>
  <p><a href="admin.html">‚Üê Colaborador</a></p>

  <div class="card"><b>Status:</b> <span id="gate">Verificando...</span></div>

  <div id="adminArea" class="hidden">

    <!-- Di√°rio -->
    <div class="row">
      <label>Data:</label><input type="date" id="dayPicker" />
      <button id="btnLoad" class="primary">Carregar</button>
      <button id="btnLogout" class="right">Sair</button>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Registros do dia</h3>
      <table>
        <thead><tr><th>Colaborador</th><th>Hor√°rio / Tipo / Obs</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- Em jornada agora -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h3 style="margin:0">Em jornada agora</h3>
        <span class="pill" id="openCount">0 colaborador(es)</span>
      </div>
      <table style="margin-top:8px">
        <thead><tr><th>Colaborador</th><th>Desde</th><th>Tempo Atual</th><th>A√ß√£o</th></tr></thead>
        <tbody id="tbodyOpen"></tbody>
      </table>
      <p class="muted" style="margin-top:6px">Amarelo &gt; 6h; vermelho &gt; 10h sem pausa/sa√≠da.</p>
    </div>

    <!-- Projetos -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Projetos</h3>
      <div class="row">
        <input id="projName" type="text" placeholder="Nome do projeto" />
        <button id="btnAddProj" class="primary">Adicionar</button>
        <span id="projMsg" class="muted"></span>
      </div>
      <ul id="projList" style="margin-top:8px"></ul>
    </div>

    <!-- Escalas/Turnos -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Escalas / Turnos</h3>
      <div class="row">
        <label>Colaborador:</label><select id="schUser"></select>
        <label>M√™s:</label><input type="month" id="schMonth" />
        <button id="btnLoadSch" class="ghost">Carregar</button>
        <button id="btnSaveSch" class="primary">Salvar altera√ß√µes</button>
      </div>
      <table style="margin-top:8px">
        <thead><tr><th>Dia</th><th>In√≠cio</th><th>Fim</th><th>Pausa (min)</th></tr></thead>
        <tbody id="tbodySch"></tbody>
      </table>
    </div>

    <!-- Relat√≥rios -->
    <div class="card">
      <h3 style="margin-top:0">Relat√≥rio mensal / Banco de horas</h3>
      <div class="row">
        <label>M√™s:</label><input type="month" id="monthPicker" />
        <label>Colaborador:</label><select id="userFilter"><option value="__all">Todos</option></select>
        <label>Jornada di√°ria (HH:MM):</label><input type="text" id="reqDaily" value="08:00" />
        <button id="btnMonth" class="primary">Gerar</button>
        <button id="btnCSV" class="ghost right">CSV</button>
        <button id="btnXLSX" class="ghost">XLSX</button>
      </div>

      <table style="margin-top:8px">
        <thead>
          <tr>
            <th>Colaborador</th><th>Dias</th><th>Trabalhado</th><th>Requerido</th>
            <th>Cr√©ditos*</th><th>D√©bito</th><th>Saldo</th><th>Saldo Ant.</th><th>Saldo Final</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbodyMonth"></tbody>
      </table>
      <p class="muted" style="margin-top:6px">* 1.5√ó normal, 2.0√ó domingos/feriados. Pausas nomeadas n√£o sofrem penalidade.</p>
    </div>

    <!-- Heatmap -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Heatmap de presen√ßa (semana atual)</h3>
      <div id="heat" class="grid"></div>
    </div>

    <!-- Timeline di√°ria -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Timeline do dia</h3>
      <div class="row">
        <label>Colaborador:</label><select id="tlUser"></select>
        <label>Data:</label><input type="date" id="tlDay" />
        <button id="btnTL" class="ghost">Mostrar</button>
      </div>
      <div id="tlWrap" style="margin-top:10px"></div>
    </div>

    <!-- Config por colaborador -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Configura√ß√£o do colaborador</h3>
      <div class="row">
        <label>Colaborador:</label><select id="userCfg"></select>
        <label>Jornada di√°ria (HH:MM):</label><input type="text" id="userDaily" value="08:00" />
        <button id="btnSaveDaily" class="primary">Salvar</button>
      </div>
    </div>

  </div>

  <script type="module">
    import * as core from './app.js';
    await core.initApp();

    const { auth, isAdmin, listAllProfiles,
            listProjects, addProject,
            listPunchesByDayAllUsers, listOpenShiftsAllUsers,
            getMonthReportForAllUsers, monthReportsToCSV, monthReportsToAOA, msToHHMM,
            setRequiredDaily, forceCloseNow, saveMonthBalance,
            getScheduleMonth, setScheduleDay, buildHeatmapGrid, listPunchesByDayForUser, buildTimeline } = core;

    const $ = id => document.getElementById(id);
    const show = (el,v)=> el.classList.toggle('hidden', !v);
    const todayLocalISO = (d=new Date())=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const monthLocalISO = (d=new Date())=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const parseMin = s=>{const [h,m]=String(s||'0:0').split(':').map(n=>parseInt(n||'0',10)); return (isNaN(h)?0:h)*60+(isNaN(m)?0:m);};

    // Tema / i18n (b√°sico)
    const theme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);
    $('btnTheme').onclick = ()=>{
      const cur = document.documentElement.getAttribute('data-theme');
      const nxt = cur==='light'?'dark':'light';
      document.documentElement.setAttribute('data-theme', nxt);
      localStorage.setItem('theme', nxt);
    };
    $('langSel').value = localStorage.getItem('lang') || 'pt';
    $('langSel').onchange = ()=> localStorage.setItem('lang', $('langSel').value);

    if ($('dayPicker')) $('dayPicker').value = todayLocalISO();
    if ($('monthPicker')) $('monthPicker').value = monthLocalISO();
    if ($('schMonth')) $('schMonth').value = monthLocalISO();
    if ($('tlDay')) $('tlDay').value = todayLocalISO();

    // Projetos
    async function refreshProjects(){
      const ps = await listProjects();
      const ul = $('projList'); ul.innerHTML='';
      ps.forEach(p=>{ const li=document.createElement('li'); li.textContent=p.name; ul.appendChild(li); });
    }
    $('btnAddProj').onclick = async ()=>{
      const name = $('projName').value.trim(); if(!name) return;
      await addProject(name); $('projName').value=''; $('projMsg').textContent='Projeto adicionado'; setTimeout(()=> $('projMsg').textContent='',1500);
      await refreshProjects();
    };

    // Di√°rio
    async function loadDaily(){
      const day = $('dayPicker').value;
      const rows = await listPunchesByDayAllUsers(day);
      const tb = $('tbody'); tb.innerHTML='';
      if (!rows.length){
        const tr=document.createElement('tr'); tr.innerHTML='<td colspan="2" class="muted">Sem registros.</td>'; tb.appendChild(tr);
      } else {
        rows.forEach(r=>{
          const d = r.at?.toDate ? r.at.toDate() : new Date(r.at||r.ts);
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${r.name||r.uid}</td><td>${d.toLocaleString('pt-BR')} (${r.type})${r.projId ? ' ‚Äî ['+r.projId+']' : ''}${r.note? ' ‚Äî '+r.note:''}</td>`;
          tb.appendChild(tr);
        });
      }
      await loadOpen();
    }

    // Em jornada
    let openInterval=null;
    async function loadOpen(){
      const day = $('dayPicker').value;
      const rows = await listOpenShiftsAllUsers(day);
      const tb = $('tbodyOpen'); tb.innerHTML='';
      $('openCount').textContent = `${rows.length} colaborador(es)`;
      if (!rows.length){
        const tr=document.createElement('tr'); tr.innerHTML='<td colspan="4" class="muted">Ningu√©m em jornada agora.</td>'; tb.appendChild(tr);
      } else {
        rows.forEach(r=>{
          const since = new Date(r.since);
          const warnClass = r.elapsedMs>10*3600000 ? 'bad' : (r.elapsedMs>6*3600000 ? 'warn' : '');
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${r.name}</td>
                          <td>${since.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</td>
                          <td><span class="pill ${warnClass}">${core.msToHHMM(r.elapsedMs)}</span></td>
                          <td><button class="danger">Encerrar</button></td>`;
          tr.querySelector('.danger').onclick = async ()=>{ if(confirm('Encerrar jornada agora?')){ await forceCloseNow(r.uid); loadOpen(); loadDaily(); } };
          tb.appendChild(tr);
        });
      }
      if (openInterval) clearInterval(openInterval);
      openInterval = setInterval(loadOpen, 30000);
    }

    // Relat√≥rios
    let lastCSV='data:text/plain;charset=utf-8,', lastAOA=[];
    async function hydrateProfiles(){
      const profiles = await listAllProfiles();
      const uf = $('userFilter'); uf.innerHTML='<option value="__all">Todos</option>';
      const uc = $('userCfg'); uc.innerHTML='';
      const su = $('schUser'); su.innerHTML='';
      const tu = $('tlUser'); tu.innerHTML='';
      profiles.forEach(p=>{
        const o1=new Option(p.name||p.uid, p.uid); uf.add(o1);
        uc.add(new Option(p.name||p.uid, p.uid));
        su.add(new Option(p.name||p.uid, p.uid));
        tu.add(new Option(p.name||p.uid, p.uid));
      });
      $('userDaily').value='08:00';
    }
    async function loadMonth(){
      const monthISO = $('monthPicker').value;
      const filter = $('userFilter').value;
      const reqMin = parseMin($('reqDaily').value || '08:00');
      const repsAll = await getMonthReportForAllUsers(monthISO, reqMin);
      const reps = filter==='__all' ? repsAll : repsAll.filter(r=>r.uid===filter);

      const tb = $('tbodyMonth'); tb.innerHTML='';
      if (!reps.length){
        const tr=document.createElement('tr'); tr.innerHTML='<td colspan="10" class="muted">Sem lan√ßamentos neste m√™s.</td>'; tb.appendChild(tr);
      } else {
        reps.forEach(r=>{
          const t=r.totals;
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${r.name || r.uid}</td>
                          <td>${r.daily.length}</td>
                          <td>${msToHHMM(t.workedMs)}</td>
                          <td>${msToHHMM(t.requiredMs)}</td>
                          <td>${msToHHMM(t.creditMs)}</td>
                          <td>${msToHHMM(t.deficitMs)}</td>
                          <td>${msToHHMM(t.balanceMs)}</td>
                          <td>${msToHHMM(t.prevBalanceMs)}</td>
                          <td><b>${msToHHMM(t.finalBalanceMs)}</b></td>
                          <td><button class="ghost close">Fechar m√™s</button></td>`;
          tr.querySelector('.close').onclick = async ()=>{ await saveMonthBalance(r.uid, monthISO, t.finalBalanceMs, true); alert('Fechamento salvo e per√≠odo travado.'); };
          tb.appendChild(tr);
        });
      }
      lastCSV = 'data:text/csv;charset=utf-8,' + encodeURIComponent(core.monthReportsToCSV(reps));
      lastAOA = core.monthReportsToAOA(reps);

      renderHeatmap(reps);
    }
    $('btnMonth').onclick = loadMonth;
    $('btnCSV').onclick = ()=>{ const a=document.createElement('a'); a.href=lastCSV; a.download=`relatorio_${$('monthPicker').value}.csv`; a.click(); };
    $('btnXLSX').onclick = ()=>{
      const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(lastAOA);
      XLSX.utils.book_append_sheet(wb, ws, 'Relat√≥rio'); XLSX.writeFile(wb, `relatorio_${$('monthPicker').value}.xlsx`);
    };

    // Config de jornada do colaborador
    $('userCfg').onchange = async ()=>{
      const uid=$('userCfg').value; const list = await listAllProfiles(); const p=list.find(x=>x.uid===uid);
      $('userDaily').value = p?.requiredDaily || '08:00';
    };
    $('btnSaveDaily').onclick = async ()=>{ const uid=$('userCfg').value; if(!uid) return; await setRequiredDaily(uid, $('userDaily').value||'08:00'); alert('Jornada di√°ria salva!'); };

    // Escalas
    $('btnLoadSch').onclick = async ()=>{
      const uid=$('schUser').value, m=$('schMonth').value;
      const map = await getScheduleMonth(uid, m);
      renderSchTable(uid, m, map);
    };
    $('btnSaveSch').onclick = async ()=>{
      const uid=$('schUser').value;
      const rows=[...document.querySelectorAll('#tbodySch tr')];
      for(const tr of rows){
        const day = tr.dataset.day;
        const start = tr.querySelector('.s').value; const end = tr.querySelector('.e').value; const br = tr.querySelector('.b').value;
        if (start || end || br) await setScheduleDay(uid, day, start||'', end||'', br||0);
      }
      alert('Escala salva!');
    };
    function renderSchTable(uid, monthISO, map){
      const [y,m]=monthISO.split('-').map(Number); const days=new Date(y, m, 0).getDate();
      const tb=$('tbodySch'); tb.innerHTML='';
      for(let d=1; d<=days; d++){
        const dayISO=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const sc=map.get(dayISO)||{};
        const tr=document.createElement('tr'); tr.dataset.day=dayISO;
        tr.innerHTML = `<td>${dayISO}</td>
                        <td><input class="s" type="time" value="${sc.start||''}"></td>
                        <td><input class="e" type="time" value="${sc.end||''}"></td>
                        <td><input class="b" type="number" min="0" step="5" style="width:80px" value="${sc.breakMin||0}"></td>`;
        tb.appendChild(tr);
      }
    }

    // Heatmap
    function renderHeatmap(reps){
      const wrap=$('heat'); wrap.innerHTML='';
      if(!reps.length){ wrap.textContent='Sem dados.'; return; }
      const grid = core.buildHeatmapGrid(reps);
      const allDays = new Set(); grid.forEach(u=>u.days.forEach(d=>allDays.add(d.dayISO)));
      const sortedDays = [...allDays].sort().slice(-7);
      const head=document.createElement('div'); head.className='heat';
      head.innerHTML = `<div><b>Colaborador</b></div>` + sortedDays.map(d=>`<div class="muted" style="font-size:12px">${d.slice(5)}</div>`).join('');
      wrap.appendChild(head);
      grid.forEach(u=>{
        const row=document.createElement('div'); row.className='heat';
        row.innerHTML = `<div>${u.name}</div>` + sortedDays.map(d=>{
          const st=u.days.find(x=>x.dayISO===d)?.status || 'abs';
          const cls = st==='ok'?'c-ok':(st==='late'?'c-late':'c-abs');
          return `<div class="cell ${cls}" title="${d} ${st}"></div>`;
        }).join('');
        wrap.appendChild(row);
      });
    }

    // Timeline di√°ria
    $('btnTL').onclick = async ()=>{
      const uid=$('tlUser').value, day=$('tlDay').value;
      const arr=await listPunchesByDayForUser(uid, day);
      const blocks=core.buildTimeline(arr);
      const wrap=$('tlWrap'); wrap.innerHTML='';
      if(!blocks.length){ wrap.innerHTML='<span class="muted">Sem blocos de trabalho.</span>'; return; }
      const total=24*60*60*1000;
      const d=new Date(day);
      const base=+new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0);
      const bar=document.createElement('div'); bar.style.position='relative'; bar.style.height='16px'; bar.style.background='#e9ebff'; bar.style.borderRadius='8px';
      blocks.forEach(b=>{
        const left=( (b.startMs-base)/total )*100, width=((b.endMs-b.startMs)/total)*100;
        const seg=document.createElement('div'); seg.style.position='absolute'; seg.style.left=left+'%'; seg.style.width=width+'%'; seg.style.height='100%'; seg.style.background='#4b4bd6'; seg.style.borderRadius='6px';
        seg.title = `${new Date(b.startMs).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})} - ${new Date(b.endMs).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}`;
        bar.appendChild(seg);
      });
      wrap.appendChild(bar);
    };

    // Autentica√ß√£o/boot
    const mAuth = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
    mAuth.onAuthStateChanged(auth, async (user)=>{
      if (!user){ $('gate').textContent='N√£o logado'; show($('adminArea'), false); return; }
      const ok = await isAdmin(user.uid);
      $('gate').textContent = ok ? 'Admin OK' : 'Sem permiss√£o';
      show($('adminArea'), ok);
      if (ok){
        const profilesLoaded = hydrateProfiles();
        await refreshProjects();
        await loadDaily();
        await loadMonth();
        await profilesLoaded;
      }
    });

    $('btnLoad').onclick = loadDaily;
    $('btnLogout').onclick = async ()=>{ const m=await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js'); await m.signOut(auth); location.href='admin.html'; };
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    }
  </script>
</body>
</html>

