<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marcação de Ponto</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    button { padding: 10px 14px; border-radius: 10px; cursor: pointer; }
    input { padding: 8px; border-radius: 8px; border:1px solid #ccc; width: 100%; }
    label { display:block; margin:8px 0 4px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>Marcação de Ponto</h1>

  <!-- Área deslogado -->
  <div id="loggedOut" class="card">
    <h3>Entrar</h3>
    <label>Email</label>
    <input id="email" type="email" required />
    <label>Senha</label>
    <input id="password" type="password" required />
    <div class="row">
      <button id="btnLogin">Login</button>
      <button id="btnRegister">Criar conta</button>
    </div>
    <p id="msg" style="color:#b00020;"></p>
  </div>

  <!-- Área logado -->
  <div id="loggedIn" class="card hidden">
    <p>Olá, <b id="who"></b></p>

    <div class="row">
      <button id="btnEntrada">Entrada</button>
      <button id="btnSaida">Saída</button>
      <label><input type="checkbox" id="geoOpt" /> Incluir minha localização (opcional)</label>
      <button id="btnLogout" style="margin-left:auto">Sair</button>
    </div>

    <label style="margin-top:8px">Observação (opcional)</label>
    <input id="note" type="text" placeholder="Ex.: visita a cliente, almoço, etc." />
    <p id="status"></p>

    <div class="card">
      <h3>Últimos registros</h3>
      <ul id="punchList"></ul>
    </div>
    <p id="dailyTotal"></p>
    <p><a href="admin.html" id="adminLink" class="hidden">Ir ao painel do Admin</a></p>
  </div>
<script type="module">
  import {
    initApp,
    auth,
    onUserChanged,
    ensureRoleDoc,
    addPunchSmart,
    listRecentPunches,
    isAdmin
  } from './app.js';

  await initApp();

  const $ = (id) => document.getElementById(id);
  const show = (el, v) => el.classList.toggle('hidden', !v);

  // ---------- LOGIN / REGISTRO / SAIR ----------
  $('btnLogin').onclick = async () => {
    $('msg').textContent = '';
    try {
      const { signInWithEmailAndPassword } =
        await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
      await signInWithEmailAndPassword(auth, $('email').value, $('password').value);
    } catch (e) { $('msg').textContent = e.message || String(e); }
  };

  $('btnRegister').onclick = async () => {
    $('msg').textContent = '';
    try {
      const { createUserWithEmailAndPassword } =
        await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
      const cred = await createUserWithEmailAndPassword(auth, $('email').value, $('password').value);
      await ensureRoleDoc(cred.user.uid);
    } catch (e) { $('msg').textContent = e.message || String(e); }
  };

  $('btnLogout').addEventListener('click', async (ev) => {
    ev.preventDefault();
    try {
      const { signOut } =
        await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
      await signOut(auth);
      $('status').textContent = 'Sessão encerrada.';
      // garante atualização visual em qualquer cache/estado
      setTimeout(() => location.reload(), 150);
    } catch (e) {
      $('status').textContent = 'Erro ao sair: ' + (e?.message || e);
    }
  });

  // ---------- BATIDA ----------
 async function doPunch(tipo) {
  const noteEl = document.getElementById('note');
  const note = noteEl ? noteEl.value : '';
  const wantGeo = document.getElementById('geoOpt')?.checked;

  document.getElementById('status').textContent = 'Registrando...';
  try {
    let geo = null;
    if (wantGeo && navigator.geolocation) {
      geo = await new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve(pos.coords),
          () => resolve(null),
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
        );
      });
    }
    await addPunchSmart(tipo, note, geo);
    document.getElementById('status').textContent = `Ponto ${tipo} registrado!`;
    if (noteEl) noteEl.value = '';
  } catch (e) {
    document.getElementById('status').textContent = 'Erro: ' + (e?.message || e);
  }
  await refreshPunches();
}
  $('btnEntrada').addEventListener('click', () => doPunch('entrada'));
  $('btnSaida').addEventListener('click',   () => doPunch('saida'));

  // ---------- LISTA ÚLTIMOS ----------
  async function refreshPunches() {
    const punches = await listRecentPunches(10);
    const ul = $('punchList'); if (!ul) return;
    
    ul.innerHTML = '';
    for (const p of punches) {
      const d = p.ts?.toDate ? p.ts.toDate() : new Date(p.ts);
      const li = document.createElement('li');
      li.textContent = `${d.toLocaleString('pt-BR')}${p.type ? ` (${p.type})` : ''}${p.note ? ' — ' + p.note : ''}`;
      ul.appendChild(li);
    }
  }

  // ---------- CICLO DE LOGIN ----------
  onUserChanged(async (user) => {
    // dentro do onUserChanged, após refreshPunches:
    const today = new Date().toISOString().slice(0,10);
    const rows = await listPunchesByDayForUser(auth.currentUser.uid, today);
    document.getElementById('dailyTotal').textContent =
      'Total de horas hoje: ' + msToHHMM(computeDailyMs(rows));
    show($('loggedOut'), !user);
    show($('loggedIn'),  !!user);
    $('who').textContent = user?.email || '';
    $('msg').textContent = '';
    $('status').textContent = '';
    if (user) {
      await ensureRoleDoc(user.uid);
      await refreshPunches();
      const admin = await isAdmin(user.uid);
      show($('adminLink'), admin);
    }
  });

  // ---------- Atalhos de teclado (ignora quando estiver digitando) ----------
  function isTypingTarget(el) {
    if (!el) return false;
    const tag = el.tagName;
    return el.isContentEditable || tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';
  }
  window.addEventListener('keydown', (e) => {
    if (!auth.currentUser) return;
    if (isTypingTarget(e.target)) return; // <- não aciona dentro de campos
    const k = e.key.toLowerCase();
    if (k === 'e') doPunch('entrada');
    if (k === 's') doPunch('saida');
  });
</script>

</body>
</html>








