<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MarcaÃ§Ã£o de Ponto</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#4b4bd6">
  <link rel="icon" href="favicon.ico">
  <style>
    :root{
      --brand:#4b4bd6; --ink:#1f2330; --mut:#6b7280; --bd:#e6e8ef; --bg:#f6f7fb; --card:#fff;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    [data-theme="dark"]{ --bg:#0f1220; --ink:#eef2ff; --mut:#9aa3b2; --card:#12162a; --bd:#242b45; }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--ink);
         font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:980px; margin:26px auto; padding:0 14px;}
    h1{margin:0 0 18px; font-size:34px; letter-spacing:.2px}
    a{color:var(--brand); text-decoration:none}
    .card{background:var(--card); border:1px solid var(--bd); border-radius:14px; padding:16px; margin:12px 0;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    input,select,button{font-size:15px}
    input[type=date],input[type=time],input[type=month],input[type=text],select{
      border:1px solid var(--bd); border-radius:10px; padding:8px 10px; background:transparent; color:inherit;
    }
    button{padding:10px 14px; border-radius:10px; border:1px solid var(--bd); background:#fff; cursor:pointer}
    [data-theme="dark"] button{background:#141a33}
    button.primary{background:var(--brand); color:#fff; border-color:var(--brand)}
    .muted{color:var(--mut)}
    .hidden{display:none}
    .pill{display:inline-block; background:rgba(75,75,214,.12); color:#dfe1ff; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700}
    .kpi{display:flex; gap:16px; align-items:center; flex-wrap:wrap; font-size:14px}
    .kpi span{background:rgba(127,138,255,.08); border:1px solid var(--bd); padding:6px 10px; border-radius:999px}
    .right{margin-left:auto}
    .tag{display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; border:1px solid var(--bd)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <h1>MarcaÃ§Ã£o de Ponto</h1>
      <div class="row">
        <button id="btnTheme" class="tag">ðŸŒ“ Tema</button>
        <select id="locale" class="tag"><option>pt</option><option>en</option><option>es</option></select>
      </div>
    </div>

    <div id="hello" class="muted" style="margin:6px 0 14px"></div>

    <div class="card">
      <div class="kpi">
        <span>Hoje: <b id="kToday">00:00</b></span>
        <span>Banco (mÃªs): <b id="kBankMonth">--:--</b></span>
        <span class="muted">CrÃ©ditos: 1.5Ã— normal, 2.0Ã— domingos/feriados. Jornada diÃ¡ria configurÃ¡vel pelo admin.</span>
        <a href="index.html" id="adminLink" class="right hidden">Painel Admin</a>
      </div>
    </div>

    <!-- Bater ponto -->
    <div id="punchCard" class="card">
      <div class="row" style="justify-content:space-between;">
        <h3 style="margin:0">Bater ponto</h3>
        <span class="pill" id="pillType">Entrada</span>
      </div>
      <div class="row" style="margin-top:8px">
        <label>Data:</label><input type="date" id="pDate" />
        <label>Hora:</label><input type="time" id="pTime" step="60" />
      </div>
      <div style="margin-top:8px">
        <label>Motivo/ObservaÃ§Ã£o</label>
        <input id="note" type="text" placeholder="Opcional" />
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnPunch" class="primary">Registrar</button>
        <button id="btnPause"  title="InÃ­cio/Fim de pausa">Pausa</button>
        <button id="btnLogout" class="right">Sair</button>
      </div>
      <p id="status" class="muted" style="margin-top:10px"></p>
    </div>

    <!-- Export meus dados -->
    <div class="card">
      <h3 style="margin:6px 0 10px">Baixar meus dados (JSON)</h3>
      <div class="row">
        <label>MÃªs:</label>
        <input type="month" id="mExport"/>
        <button id="btnExport">Baixar</button>
      </div>
    </div>

    <!-- Registros do dia -->
    <div class="card">
      <h3 style="margin:6px 0 10px">Registros de hoje</h3>
      <ul id="listToday" class="clean" style="margin:0; padding-left:20px"></ul>
    </div>
  </div>

<script type="module">
  import {
    initApp, auth, onUserChanged, ensureRoleDoc, isAdmin,
    addPunchAuto, startPause, endPause,
    listPunchesByDayForUser, getNextTypeFor,
    computeDailyWorkMs, msToHHMM, requestAdjustment,
    getMonthReportForUser, getStatus
  } from './app.js';

  await initApp();

  const $ = id => document.getElementById(id);
  const show = (el,v)=> el.classList.toggle('hidden', !v);
  const fmt = (d)=> d.toLocaleString(($('locale').value||'pt')+'-BR',
                        {hour:'2-digit',minute:'2-digit'});

  // Tema
  const root = document.documentElement;
  $('btnTheme').onclick = ()=> {
    root.setAttribute('data-theme', root.getAttribute('data-theme')==='dark'?'light':'dark');
  };

  function nowToInputs(){
    const n=new Date();
    $('pDate').value = n.toISOString().slice(0,10);
    $('pTime').value = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
  }

  async function refreshType(){
    const user = auth.currentUser; if(!user) return;
    const next = await getNextTypeFor(user.uid);
    $('pillType').textContent = (next==='entrada' ? 'Entrada' : (next==='saida'?'SaÃ­da':'Fim de pausa'));
    $('btnPunch').textContent = 'Registrar ' + (next==='entrada' ? 'Entrada' : (next==='saida'?'SaÃ­da':'Fim de pausa'));
  }

  async function refreshBankWidget(){
    const u=auth.currentUser; if(!u) return;
    const m = new Date().toISOString().slice(0,7);
    const rep = await getMonthReportForUser(u.uid, m);
    $('kBankMonth').textContent = msToHHMM(rep.totals.balanceMs);
  }

  async function refreshToday(){
    const u=auth.currentUser; if(!u) return;
    const day = new Date().toISOString().slice(0,10);
    const arr = await listPunchesByDayForUser(u.uid, day);

    // lista
    const ul=$('listToday'); ul.innerHTML='';
    if(!arr.length){
      const li=document.createElement('li'); li.className='muted'; li.textContent='Nenhum registro hoje.'; ul.appendChild(li);
    }else{
      for(const p of arr){
        const when = p.at?.toDate ? p.at.toDate() : new Date(p.at||p.ts);
        const li=document.createElement('li');
        li.style.marginBottom='10px';
        li.textContent = `${fmt(when)} (${p.type})` + (p.note?` â€” ${p.note}`:'');
        // AÃ§Ãµes de ajuste
        const btns=document.createElement('div'); btns.className='row'; btns.style.marginTop='6px';
        const b1=document.createElement('button'); b1.textContent='Pedir exclusÃ£o';
        b1.onclick = async ()=>{
          const reason = prompt('Explique o motivo da exclusÃ£o:')||'';
          await requestAdjustment({ action:'delete', targetPath:p._path, type:p.type, reason });
          alert('Pedido enviado.');
        };
        const b2=document.createElement('button'); b2.textContent='Pedir ajuste horÃ¡rio';
        b2.onclick = async ()=>{
          const d = when.toISOString().slice(0,10);
          const hh = String(when.getHours()).padStart(2,'0');
          const mm = String(when.getMinutes()).padStart(2,'0');
          const nh = prompt('Novo horÃ¡rio HH:MM', `${hh}:${mm}`); if(!nh) return;
          const rs = prompt('Motivo do ajuste:')||'';
          await requestAdjustment({ dateISO:d, timeHHMM:nh, type:p.type, reason:rs, action:'include' });
          alert('Pedido de ajuste enviado.');
        };
        btns.appendChild(b1); btns.appendChild(b2);
        li.appendChild(document.createElement('br'));
        li.appendChild(btns);
        ul.appendChild(li);
      }
    }

    // total do dia
    $('kToday').textContent = msToHHMM(computeDailyWorkMs(arr));
  }

  // BotÃµes
  $('btnPunch').onclick = async ()=>{
    $('status').textContent = 'Registrando...';
    try{
      const d = new Date($('pDate').value || new Date());
      const [hh,mm] = ($('pTime').value||'00:00').split(':').map(x=>parseInt(x||'0',10));
      d.setHours(hh,mm,0,0);
      await addPunchAuto({ at:d, note:$('note').value||'' });
      $('status').textContent='Ponto registrado!';
      $('note').value='';
      await refreshType(); await refreshToday(); await refreshBankWidget();
    }catch(e){ $('status').textContent='Erro: ' + (e?.message||e); }
  };

  $('btnPause').onclick = async ()=>{
    const st = await getStatus(auth.currentUser.uid);
    if (!st.hasOpen) { alert('VocÃª ainda nÃ£o registrou a entrada.'); return; }
    if (st.hasBreakOpen) await endPause({ note:'Fim da pausa' });
    else await startPause({ note:'InÃ­cio da pausa' });
    await refreshType(); await refreshToday();
  };

  $('btnExport').onclick = async ()=>{
    const u=auth.currentUser; if(!u) return;
    const mISO = $('mExport').value || new Date().toISOString().slice(0,7);
    const from = `${mISO}-01`, to = `${mISO}-31`;
    const data = await (await import('./app.js')).exportUserDataJSON(u.uid, from, to);
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `ponto-${mISO}-${u.uid}.json`; a.click();
  };

  $('btnLogout').onclick = async ()=>{
    const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
    await m.signOut(auth); location.href='login.html';
  };

  // login state
  onUserChanged(async (user)=>{
    if(!user){ location.href='login.html'; return; }
    $('hello').textContent = `OlÃ¡, ${user.displayName||user.email||''}`;
    await ensureRoleDoc(user.uid, user.displayName||'', user.email||'');

    // link admin
    const admin = await isAdmin(user.uid);
    show($('adminLink'), admin);

    nowToInputs();
    await refreshType();
    await refreshToday();
    await refreshBankWidget();

    // Admin tambÃ©m vÃª a Ã¡rea de batida
    $('punchCard').classList.remove('hidden');
  });
</script>
</body>
</html>
