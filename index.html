<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marcação de Ponto</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 860px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    button { padding: 10px 14px; border-radius: 10px; cursor: pointer; }
    input, select { padding: 8px; border-radius: 8px; border:1px solid #ccc; }
    label { display:block; margin:8px 0 4px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .hidden { display:none; }
    ul { padding-left: 18px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; font-size:12px; margin-left:6px; }
    .ok { color:#0a7a0a; } .warn { color:#b00020; }
  </style>
</head>
<body>
  <h1>Marcação de Ponto <span id="queueBadge" class="pill hidden"></span></h1>

  <!-- ===== deslogado ===== -->
  <div id="loggedOut" class="card">
    <h3>Entrar</h3>
    <label>Email</label>
    <input id="email" type="email" />
    <label>Senha</label>
    <input id="password" type="password" />
    <div class="row">
      <button id="btnLogin">Login</button>
      <button id="btnRegister">Criar conta</button>
    </div>
    <p id="msg" style="color:#b00020;"></p>
  </div>

  <!-- ===== logado ===== -->
  <div id="loggedIn" class="hidden">
    <p>Olá, <b id="who"></b></p>

    <!-- Batida -->
    <div class="card">
      <h3>Bater ponto</h3>
      <div class="row">
        <label>Data:
          <input type="date" id="pDate">
        </label>
        <label>Hora:
          <input type="time" id="pTime" step="60">
        </label>
        <div>Tipo (detectado): <b id="autoType">—</b></div>
      </div>
      <label>Motivo/Observação</label>
      <input id="note" type="text" placeholder="Opcional" style="width:100%" />
      <div class="row" style="margin-top:8px">
        <button id="btnPunchSave">Registrar <span id="btnTypeLabel">Entrada</span></button>
        <button id="btnSync" type="button">Sincronizar fila</button>
        <button id="btnLogout" style="margin-left:auto">Sair</button>
      </div>
      <p id="status"></p>
      <small>Se estiver sem internet, o ponto fica na fila e sincroniza quando a conexão voltar.</small>
    </div>

    <!-- Banco de horas -->
    <div class="card">
      <h3>Banco de horas</h3>
      <div class="row">
        <div><b>Hoje:</b> <span id="bankToday">—</span></div>
        <div><b>Mês atual:</b> <span id="bankMonth">—</span></div>
      </div>
    </div>

    <!-- Registros de hoje -->
    <div class="card">
      <h3>Registros de hoje</h3>
      <ul id="todayList"><li>Nenhum registro hoje.</li></ul>
    </div>

    <!-- Último registro + ações -->
    <div class="card">
      <h3>Último registro</h3>
      <ul id="punchList"></ul>
      <div class="row">
        <button id="btnAdjFromLast" type="button">Ajustar este ponto…</button>
        <button id="btnReqDelete" type="button">Pedir exclusão deste ponto…</button>
      </div>
    </div>

    <!-- Ajuste -->
    <div class="card">
      <h3>Solicitar ajuste</h3>
      <div class="row">
        <label>Data: <input type="date" id="adjDate"></label>
        <label>Hora: <input type="time" id="adjTime" step="60"></label>
        <label>Tipo:
          <select id="adjType">
            <option value="entrada">Entrada</option>
            <option value="saida">Saída</option>
          </select>
        </label>
      </div>
      <label>Motivo</label>
      <input id="adjReason" type="text" placeholder="Explique o ajuste..." style="width:100%" />
      <button id="btnAdjSend">Enviar pedido</button>
      <p id="adjMsg"></p>
    </div>

    <p><a href="admin.html" id="adminLink" class="hidden">Ir ao painel do Admin</a></p>
  </div>

  <script type="module">
    import {
      initApp, auth, onUserChanged, ensureRoleDoc, isAdmin,
      addPunch, listRecentPunchesRaw, requestAdjustment,
      listPunchesByDayForUser, computeDailyMs, msToHHMM,
      computeDailyBank, computeMonthlyBank, getUserProfile
    } from './app.js';

    await initApp();
    const $ = id => document.getElementById(id);
    const show = (el, v) => el && el.classList.toggle('hidden', !v);

    // ========= fila offline (localStorage) =========
    const QUEUE_KEY = 'ponto_queue_v1';
    function readQueue(){ try{ return JSON.parse(localStorage.getItem(QUEUE_KEY)||'[]'); }catch{ return []; } }
    function writeQueue(arr){ localStorage.setItem(QUEUE_KEY, JSON.stringify(arr)); }
    function renderQueueBadge(){
      const n = readQueue().length;
      $('queueBadge').textContent = n + ' pend.';
      show($('queueBadge'), n>0);
      show($('btnSync'), n>0);
    }
    renderQueueBadge();

    // ========= util =========
    function setNow() {
      const now = new Date();
      $('pDate').value = now.toISOString().slice(0,10);
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      $('pTime').value = hh + ':' + mm;
    }
    function ymd(d){ return d.toISOString().slice(0,10); }

    setNow();

    // ========= login =========
    $('btnLogin').onclick = async () => {
      $('msg').textContent='';
      try {
        const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
        await m.signInWithEmailAndPassword(auth, $('email').value, $('password').value);
      } catch(e) { $('msg').textContent = e.message || String(e); }
    };
    $('btnRegister').onclick = async () => {
      $('msg').textContent='';
      try {
        const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
        const cred = await m.createUserWithEmailAndPassword(auth, $('email').value, $('password').value);
        await ensureRoleDoc(cred.user.uid);
      } catch(e) { $('msg').textContent = e.message || String(e); }
    };
    $('btnLogout').onclick = async (ev) => {
      ev.preventDefault();
      try {
        const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
        await m.signOut(auth); location.reload();
      } catch(e) { $('status').textContent = 'Erro ao sair: ' + (e.message||e); }
    };

    // ========= detectar tipo automático =========
    async function refreshAutoType() {
      const last = await listRecentPunchesRaw(1);
      const today = new Date().toISOString().slice(0,10);
      const lastIsEntradaHoje = (last[0] && (last[0].at?.toDate?.() || last[0].ts?.toDate?.() || new Date(last[0].ts)))
        && ymd((last[0].at?.toDate?.() || last[0].ts?.toDate?.() || new Date(last[0].ts))) === today
        && last[0].type === 'entrada';
      const next = lastIsEntradaHoje ? 'Saída' : 'Entrada';
      $('autoType').textContent = next;
      $('btnTypeLabel').textContent = next;
    }

    // ========= registrar ponto =========
    $('btnPunchSave').onclick = async () => {
      const dateISO = $('pDate').value;
      const time = $('pTime').value;
      const note = $('note').value || '';
      if(!dateISO || !time){ $('status').textContent = 'Informe data e hora.'; return; }
      const [hh,mm] = time.split(':').map(Number);
      const at = new Date(dateISO); at.setHours(hh||0, mm||0, 0, 0);

      $('status').textContent = 'Registrando...';
      try {
        await addPunch(note, at, null);
        $('status').textContent = 'Ponto registrado!';
        $('note').value = '';
        await refreshAll();
      } catch(e) {
        // cai para fila local (offline ou permissão momentânea)
        const q = readQueue();
        q.push({ note, at: at.toISOString() });
        writeQueue(q);
        $('status').textContent = 'Sem conexão ou permissão momentânea. Adicionado à fila.';
        renderQueueBadge();
      }
    };

    $('btnSync').onclick = async () => {
      const q = readQueue(); if (!q.length) return;
      let ok = 0, fail = 0;
      for (const item of q) {
        try {
          await addPunch(item.note || '', new Date(item.at), null);
          ok++;
        } catch(e) { fail++; }
      }
      writeQueue([]);
      renderQueueBadge();
      $('status').textContent = fail ? `Sincronizado com falhas (${ok} ok, ${fail} erro).`
                                     : `Sincronizado (${ok} enviados).`;
      await refreshAll();
    };

    // ========= listas/paineis =========
    async function refreshLast() {
      const list = await listRecentPunchesRaw(1);
      const ul = $('punchList'); ul.innerHTML = '';
      const li = document.createElement('li');
      if (!list.length) { li.textContent = 'Sem registros ainda.'; ul.appendChild(li); return; }
      const d = list[0];
      const when = (d.at?.toDate?.() || d.ts?.toDate?.() || new Date());
      li.textContent = when.toLocaleString('pt-BR') + (d.type? ` (${d.type})`:'') + (d.note? ' — '+d.note:'');
      ul.appendChild(li);
    }

    async function refreshTodayList() {
      if (!auth.currentUser) return;
      const dayISO = new Date().toISOString().slice(0,10);
      const rows = await listPunchesByDayForUser(auth.currentUser.uid, dayISO);
      const ul = $('todayList'); ul.innerHTML = '';
      if (!rows.length) { ul.innerHTML = '<li>Nenhum registro hoje.</li>'; return; }
      rows.sort((a,b) => {
        const ta=(a.at?.toMillis?.()||a.ts?.toMillis?.()||new Date(a.ts).getTime());
        const tb=(b.at?.toMillis?.()||b.ts?.toMillis?.()||new Date(b.ts).getTime());
        return ta-tb;
      });
      for (const r of rows) {
        const when = r.at?.toDate?.() || r.ts?.toDate?.() || new Date(r.ts);
        const li = document.createElement('li');
        li.textContent = `${when.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})} (${r.type})` + (r.note? ' — '+r.note:'');
        ul.appendChild(li);
      }
    }

    async function refreshBanks() {
      if (!auth.currentUser) return;
      const dayISO = new Date().toISOString().slice(0,10);
      const daily = await computeDailyBank(auth.currentUser.uid, dayISO);
      $('bankToday').innerHTML = `${daily.bankMs>=0?'<span class="ok">':''}${msToHHMM(daily.bankMs)}${daily.bankMs>=0?'</span>':''}  ` +
        `<small class="pill">req: ${msToHHMM(daily.reqMs)} • trab: ${msToHHMM(daily.workedMs)} • fator: ${daily.rate}x${daily.holiday?' (feriado)':''}</small>`;

      const ym = dayISO.slice(0,7).replace('-','');
      const monthMs = await computeMonthlyBank(auth.currentUser.uid, ym);
      $('bankMonth').innerHTML = `${monthMs>=0?'<span class="ok">':''}${msToHHMM(monthMs)}${monthMs>=0?'</span>':''}`;
    }

    async function refreshHeaderName(user){
      const profile = await getUserProfile(user.uid);
      $('who').textContent = profile?.name || (user.email||'');
    }

    async function refreshAll(){
      await Promise.all([
        refreshAutoType(),
        refreshLast(),
        refreshTodayList(),
        refreshBanks()
      ]);
    }

    // Ajustes rápidos
    let lastDoc = null;
    $('btnAdjFromLast').onclick = async () => {
      const list = await listRecentPunchesRaw(1);
      if (!list.length) return;
      lastDoc = list[0];
      const when = lastDoc.at?.toDate?.() || lastDoc.ts?.toDate?.() || new Date();
      $('adjDate').value = when.toISOString().slice(0,10);
      $('adjTime').value = String(when.getHours()).padStart(2,'0')+':'+String(when.getMinutes()).padStart(2,'0');
      $('adjType').value = lastDoc.type || 'entrada';
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };
    $('btnReqDelete').onclick = async () => {
      if (!lastDoc || !lastDoc._path) { alert('Não foi possível identificar o ponto.'); return; }
      const reason = prompt('Explique por que deseja excluir este ponto:') || '';
      try {
        await requestAdjustment({ action:'delete', targetPath:lastDoc._path, type:lastDoc.type||'entrada', reason });
        alert('Pedido de exclusão enviado.');
      } catch(e){ alert('Erro: ' + (e.message||e)); }
    };
    $('btnAdjSend').onclick = async () => {
      try{
        await requestAdjustment({
          dateISO: $('adjDate').value,
          timeHHMM: $('adjTime').value,
          type: $('adjType').value,
          reason: $('adjReason').value || ''
        });
        $('adjMsg').textContent = 'Pedido enviado. Aguarde aprovação.';
        $('adjReason').value = '';
      }catch(e){ $('adjMsg').textContent = 'Erro: ' + (e.message||e); }
    };

    // ciclo login
    onUserChanged(async (user) => {
      show($('loggedOut'), !user);
      show($('loggedIn'),  !!user);
      $('msg').textContent = ''; $('status').textContent = '';
      if (user) {
        await ensureRoleDoc(user.uid);
        await refreshHeaderName(user);
        const admin = await isAdmin(user.uid);
        show($('adminLink'), admin);
        setNow();
        await refreshAll();
      }
    });
  </script>
</body>
</html>
