<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marcação de Ponto</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    button { padding: 10px 14px; border-radius: 10px; cursor: pointer; }
    input, select { padding: 8px; border-radius: 8px; border:1px solid #ccc; width: 100%; }
    label { display:block; margin:8px 0 4px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .hidden { display:none; }
    small.muted { color:#777 }
    ul.clean { list-style: none; padding-left: 0; }
    ul.clean li { display:flex; gap:8px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom: 1px dashed #eee; }
    .warn { color:#b00020; font-weight:600; }
    .inline { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <h1>Marcação de Ponto</h1>

  <!-- ===== deslogado ===== -->
  <div id="loggedOut" class="card">
    <h3>Entrar</h3>
    <label>Email</label>
    <input id="email" type="email" />
    <label>Senha</label>
    <input id="password" type="password" />
    <div class="row">
      <button id="btnLogin">Login</button>
      <button id="btnRegister">Criar conta</button>
    </div>
    <p id="msg" style="color:#b00020;"></p>
  </div>

  <!-- ===== logado (colaborador) ===== -->
  <div id="loggedIn" class="card hidden">
    <p>Olá, <b id="who"></b></p>

    <!-- Batida -->
    <div id="punchCard" class="card">
      <h3>Bater ponto</h3>
      <div class="row">
        <label>Data:
          <input type="date" id="pDate">
        </label>
        <label>Hora:
          <input type="time" id="pTime" step="60">
        </label>
        <label>Tipo (detectado):
          <div><b id="autoType">Entrada</b></div>
        </label>
      </div>
      <label>Motivo/Observação</label>
      <input id="note" type="text" placeholder="Opcional" />
      <div class="row">
        <button id="btnPunchSave">Registrar ponto</button>
        <button id="btnLogout" style="margin-left:auto">Sair</button>
      </div>
      <p id="status"></p>
      <small class="muted">A localização é obrigatória e validada pelo raio dos locais cadastrados.</small>
    </div>

    <!-- Total do dia -->
    <p id="dailyTotal" style="font-weight:bold"></p>

    <!-- Histórico de hoje -->
    <div id="todayCard" class="card">
      <h3>Registros de hoje</h3>
      <p id="parityMsg" class="warn hidden">Atenção: Entradas e Saídas estão em quantidade diferente.</p>
      <ul id="todayList" class="clean"></ul>
    </div>

    <!-- Último registro + ações -->
    <div id="lastCard" class="card">
      <h3>Último registro</h3>
      <ul id="punchList"></ul>
      <div class="row">
        <button id="btnAdjFromLast" type="button">Ajustar este ponto…</button>
        <button id="btnReqDelete" type="button">Pedir exclusão deste ponto…</button>
      </div>
      <small id="lastMeta" class="muted"></small>
    </div>

    <!-- Solicitar ajuste (com templates de motivo) -->
    <div id="adjustCard" class="card">
      <h3>Solicitar ajuste</h3>
      <div class="row">
        <label>Data: <input type="date" id="adjDate"></label>
        <label>Hora: <input type="time" id="adjTime" step="60"></label>
        <label>Tipo:
          <select id="adjType">
            <option value="entrada">Entrada</option>
            <option value="saida">Saída</option>
          </select>
        </label>
      </div>

      <div class="row inline">
        <label style="margin:0">Motivo</label>
        <select id="adjReasonTpl">
          <option value="">— Escolher motivo —</option>
          <option>Esqueci a batida</option>
          <option>Trabalho externo</option>
          <option>Problema no aparelho</option>
          <option>Intervalo fora do horário</option>
          <option>Outro</option>
        </select>
      </div>
      <input id="adjReason" type="text" placeholder="Explique o ajuste..." />

      <button id="btnAdjSend">Enviar pedido</button>
      <p id="adjMsg"></p>
    </div>

    <p><a href="admin.html" id="adminLink" class="hidden">Ir ao painel do Admin</a></p>
  </div>

  <!-- ===== mensagem para administradores ===== -->
  <div id="adminOnly" class="card hidden">
    <p>Você é administrador. Use o <a href="admin.html">painel do administrador</a> para gerenciar pontos, locais e solicitações.</p>
  </div>

  <script type="module">
    import {
      initApp, auth, onUserChanged, ensureRoleDoc, isAdmin,
      addPunch, listRecentPunchesRaw, requestAdjustment,
      listPunchesByDayForUser, computeDailyMs, msToHHMM,
      nearestSite
    } from './app.js';

    await initApp();
    const $ = (id) => document.getElementById(id);
    const show = (el,v) => { if (el) el.classList.toggle('hidden', !v); };

    // Preenche data/hora com "agora" ao carregar (o usuário pode editar se quiser)
    function setNow() {
      const now = new Date();
      $('pDate').value = now.toISOString().slice(0,10);
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      $('pTime').value = hh + ':' + mm;
    }
    setNow();

    // detecta próximo tipo do dia escolhido
    let nextType = 'entrada';
    async function computeNextType() {
      if (!auth.currentUser) return;
      const day = $('pDate').value || new Date().toISOString().slice(0,10);
      const rows = await listPunchesByDayForUser(auth.currentUser.uid, day);
      rows.sort((a,b)=>{
        const ta = a.at?.toMillis ? a.at.toMillis() : (a.ts?.toMillis ? a.ts.toMillis() : new Date(a.ts).getTime());
        const tb = b.at?.toMillis ? b.at.toMillis() : (b.ts?.toMillis ? b.ts.toMillis() : new Date(b.ts).getTime());
        return ta - tb;
      });
      nextType = rows.length === 0 ? 'entrada' : (rows[rows.length-1].type === 'entrada' ? 'saida' : 'entrada');
      $('autoType').textContent = nextType.charAt(0).toUpperCase() + nextType.slice(1);
    }
    $('pDate').addEventListener('change', computeNextType);

    // login/registro/sair
    $('btnLogin').onclick = async () => {
      $('msg').textContent = '';
      try {
        const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
        await m.signInWithEmailAndPassword(auth, $('email').value, $('password').value);
      } catch (e) { $('msg').textContent = e?.message || String(e); }
    };
    $('btnRegister').onclick = async () => {
      $('msg').textContent = '';
      try {
        const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
        const cred = await m.createUserWithEmailAndPassword(auth, $('email').value, $('password').value);
        await ensureRoleDoc(cred.user.uid);
      } catch (e) { $('msg').textContent = e?.message || String(e); }
    };
    $('btnLogout').onclick = async (ev) => {
      ev.preventDefault();
      try {
        const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
        await m.signOut(auth);
        setTimeout(() => location.reload(), 150);
      } catch (e) { $('status').textContent = 'Erro ao sair: ' + (e?.message || e); }
    };

    // geolocalização
    async function getGeoOrFail() {
      if (!('geolocation' in navigator)) throw new Error('Seu navegador não suporta geolocalização.');
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve(pos.coords),
          (err) => reject(err),
          { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
        );
      });
    }

    // Registrar ponto
    $('btnPunchSave').onclick = async () => {
      const dateISO = $('pDate').value;
      const time = $('pTime').value;
      const note = $('note').value || '';
      if (!dateISO || !time) { $('status').textContent = 'Informe data e hora.'; return; }

      $('status').textContent = 'Coletando localização...';
      let geo;
      try { geo = await getGeoOrFail(); }
      catch (err) {
        const msg = (err?.code===1) ? 'Permita o acesso à localização.' :
                    (err?.code===3) ? 'Tempo excedido ao obter localização.' :
                    'Não foi possível obter localização.';
        $('status').textContent = msg; return;
      }

      let site = null;
      try { site = await nearestSite(geo); } catch (_) {}
      if (!site) { $('status').textContent = 'Fora das áreas válidas para batida.'; return; }

      const hh = parseInt(time.split(':')[0],10) || 0;
      const mm = parseInt(time.split(':')[1],10) || 0;
      const at = new Date(dateISO); at.setHours(hh, mm, 0, 0);

      $('status').textContent = 'Registrando ponto...';
      try {
        await addPunch(note, nextType, geo, at, site.id, site.distM, '', site.name);
        $('status').textContent = 'Ponto registrado!';
        $('note').value = '';
        await refreshLast();
        await refreshToday();
        await computeNextType();
        try { await updateDailyTotal(); } catch (e) {}
      } catch (e) {
        const msg = (e?.code === 'permission-denied') ? 'Fora das áreas permitidas ou Local inválido.' : (e?.message || e);
        $('status').textContent = 'Erro: ' + msg;
      }
    };

    // Último registro
    let lastDoc = null;
    async function refreshLast() {
      const list = await listRecentPunchesRaw(1);
      const ul = $('punchList'); ul.innerHTML = '';
      const li = document.createElement('li');
      if (!list.length) {
        lastDoc = null; li.textContent = 'Sem registros ainda.'; ul.appendChild(li); $('lastMeta').textContent = ''; return;
      }
      const d = list[0]; lastDoc = d;
      const when = (d.at?.toDate ? d.at.toDate() : (d.ts?.toDate ? d.ts.toDate() : new Date()));
      const tipo = d.type ? ' (' + d.type + ')' : '';
      const obs  = d.note ? ' — ' + d.note : '';
      li.textContent = when.toLocaleString('pt-BR') + tipo + obs;
      ul.appendChild(li);
      $('lastMeta').textContent = d.siteId ? ('Local: ' + (d.siteName || d.siteId) + ' • Dist: ' + Math.round(d.distM || 0) + ' m') : '';
    }
    $('btnAdjFromLast').onclick = () => {
      if (!lastDoc) return;
      const when = lastDoc.at?.toDate ? lastDoc.at.toDate() : (lastDoc.ts?.toDate ? lastDoc.ts.toDate() : new Date());
      $('adjDate').value = when.toISOString().slice(0,10);
      $('adjTime').value = String(when.getHours()).padStart(2,'0') + ':' + String(when.getMinutes()).padStart(2,'0');
      $('adjType').value = lastDoc.type || 'entrada';
      selectedTargetPath = lastDoc._path || null;
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };
    $('btnReqDelete').onclick = async () => {
      if (!lastDoc || !lastDoc._path) { alert('Não foi possível identificar o ponto.'); return; }
      const reason = prompt('Explique por que deseja excluir este ponto:') || '';
      try {
        await requestAdjustment({ action:'delete', targetPath:lastDoc._path, type:lastDoc.type||'entrada', reason });
        alert('Pedido de exclusão enviado.');
      } catch (e) { alert('Erro: ' + (e?.message || e)); }
    };

    // Histórico do dia
    let selectedTargetPath = null;
    async function refreshToday(){
      if (!auth.currentUser) return;
      const today = new Date().toISOString().slice(0,10);
      const rows = await listPunchesByDayForUser(auth.currentUser.uid, today);
      rows.sort((a,b)=>{
        const ta = a.at?.toMillis ? a.at.toMillis() : (a.ts?.toMillis ? a.ts.toMillis() : new Date(a.ts).getTime());
        const tb = b.at?.toMillis ? b.at.toMillis() : (b.ts?.toMillis ? b.ts.toMillis() : new Date(b.ts).getTime());
        return ta - tb;
      });

      const nE = rows.filter(r=>r.type==='entrada').length;
      const nS = rows.filter(r=>r.type==='saida').length;
      show($('parityMsg'), nE!==nS);

      const ul = $('todayList'); ul.innerHTML = '';
      rows.forEach((r)=>{
        const dt = r.at?.toDate ? r.at.toDate() : (r.ts?.toDate ? r.ts.toDate() : new Date(r.ts));
        const li = document.createElement('li');
        const left = document.createElement('div');
        left.textContent = `${dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})} (${r.type}) ${r.note? '— '+r.note : ''}`;
        const right = document.createElement('div');

        const btnAdj = document.createElement('button');
        btnAdj.textContent = 'Ajustar';
        btnAdj.onclick = () => {
          $('adjDate').value = dt.toISOString().slice(0,10);
          $('adjTime').value = String(dt.getHours()).padStart(2,'0') + ':' + String(dt.getMinutes()).padStart(2,'0');
          $('adjType').value = r.type || 'entrada';
          selectedTargetPath = r._path || null;
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        };

        const btnDel = document.createElement('button');
        btnDel.textContent = 'Excluir';
        btnDel.onclick = async () => {
          if (!r._path) return alert('Não foi possível identificar o ponto.');
          const why = prompt('Explique por que deseja excluir este ponto:') || '';
          try {
            await requestAdjustment({ action:'delete', targetPath:r._path, type:r.type||'entrada', reason:why });
            alert('Pedido de exclusão enviado.');
          } catch(e){ alert('Erro: '+(e?.message||e)); }
        };

        right.appendChild(btnAdj);
        right.appendChild(btnDel);
        li.appendChild(left);
        li.appendChild(right);
        ul.appendChild(li);
      });
    }

    // motivo template -> preenche o input
    $('adjReasonTpl').addEventListener('change', (e)=>{
      if (!e.target.value) return;
      const cur = $('adjReason').value.trim();
      $('adjReason').value = cur ? `${cur}; ${e.target.value}` : e.target.value;
      e.target.value = '';
    });

    // enviar ajuste
    $('btnAdjSend').onclick = async () => {
      try {
        const payload = {
          dateISO: $('adjDate').value,
          timeHHMM: $('adjTime').value,
          type: $('adjType').value,
          reason: $('adjReason').value || ''
        };
        if (selectedTargetPath) {
          payload.action = 'update';
          payload.targetPath = selectedTargetPath;
        }
        await requestAdjustment(payload);
        $('adjMsg').textContent = 'Pedido enviado. Aguarde aprovação.';
        $('adjReason').value = '';
        selectedTargetPath = null;
      } catch (e) { $('adjMsg').textContent = 'Erro: ' + (e?.message || e); }
    };

    async function updateDailyTotal() {
      if (!auth.currentUser) return;
      const el = $('dailyTotal'); if (!el) return;
      const today = new Date().toISOString().slice(0,10);
      const rows = await listPunchesByDayForUser(auth.currentUser.uid, today);
      el.textContent = 'Total de horas hoje: ' + msToHHMM(computeDailyMs(rows));
    }

    // ciclo de login + admins não batem ponto
    onUserChanged(async (user) => {
      const isLogged = !!user;
      show($('loggedOut'), !isLogged);
      if (!isLogged) return;

      $('who').textContent = user.email || '';
      $('msg').textContent = ''; $('status').textContent = '';

      await ensureRoleDoc(user.uid);
      const admin = await isAdmin(user.uid);

      show($('adminOnly'), admin);
      show($('loggedIn'), !admin);
      show($('punchCard'), !admin);
      show($('todayCard'), !admin);
      show($('lastCard'), !admin);
      show($('adjustCard'), !admin);
      show($('adminLink'), admin);

      if (!admin) {
        await refreshLast();
        await refreshToday();
        await computeNextType();
        try { await updateDailyTotal(); } catch (e) {}
      }
    });
  </script>
</body>
</html>
