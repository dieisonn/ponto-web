<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marcação de Ponto</title>

  <style>
    /* Estilos simples para ficar usável e limpo */
    body { font-family: system-ui, Arial; max-width: 720px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    button { padding: 10px 14px; border-radius: 10px; cursor: pointer; }
    input, select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 100%; }
    label { display:block; margin:8px 0 4px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>Marcação de Ponto</h1>

  <!-- ======= Tela deslogado ======= -->
  <div id="loggedOut" class="card">
    <h3>Entrar</h3>
    <label>Email</label>
    <input id="email" type="email" required />
    <label>Senha</label>
    <input id="password" type="password" required />
    <div class="row">
      <button id="btnLogin">Login</button>
      <button id="btnRegister">Criar conta</button>
    </div>
    <p id="msg" style="color:#b00020;"></p>
  </div>

  <!-- ======= Tela logado ======= -->
  <div id="loggedIn" class="card hidden">
    <p>Olá, <b id="who"></b></p>

    <div class="row">
      <button id="btnEntrada">Entrada</button>
      <button id="btnSaida">Saída</button>
      <button id="btnLogout" style="margin-left:auto">Sair</button>
    </div>

    <!-- Geo opcional -->
    <label><input type="checkbox" id="geoOpt" /> Incluir minha localização (opcional)</label>

    <label style="margin-top:8px">Observação (opcional)</label>
    <input id="note" type="text" placeholder="Ex.: visita a cliente, almoço, etc." />
    <p id="status"></p>

    <!-- Total do dia -->
    <p id="dailyTotal" style="font-weight:bold"></p>

    <div class="card">
      <h3>Último registro</h3>
      <ul id="punchList"></ul>
    </div>

    <!-- Solicitar ajuste ao admin -->
    <div class="card">
      <h3>Solicitar ajuste</h3>
      <div class="row">
        <label>Data: <input type="date" id="adjDate"></label>
        <label>Hora: <input type="time" id="adjTime"></label>
        <label>Tipo:
          <select id="adjType">
            <option value="entrada">Entrada</option>
            <option value="saida">Saída</option>
          </select>
        </label>
      </div>
      <label>Motivo</label>
      <input id="adjReason" type="text" placeholder="Explique o ajuste..." />
      <button id="btnAdjSend">Enviar pedido</button>
      <p id="adjMsg"></p>
    </div>

    <p><a href="admin.html" id="adminLink" class="hidden">Ir ao painel do Admin</a></p>
  </div>

  <!-- ======= Lógica da página ======= -->
  <script type="module">
    /* Importa funções do app.js */
    import {
      initApp, auth, onUserChanged, ensureRoleDoc,
      addPunchSmart, listRecentPunches, isAdmin,
      requestAdjustment, listPunchesByDayForUser, computeDailyMs, msToHHMM
    } from './app.js';

    /* Inicializa Firebase (obrigatório antes de usar auth/db) */
    await initApp();

    /* Helpers */
    function $(id){ return document.getElementById(id); }
    function show(el, v){ if (el) el.classList.toggle('hidden', !v); }

    /* ===== Login / Registro / Sair ===== */
    const bLogin = $('btnLogin');
    if (bLogin) bLogin.onclick = async function () {
      $('msg').textContent = '';
      try {
        const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
        await m.signInWithEmailAndPassword(auth, $('email').value, $('password').value);
      } catch (e) {
        $('msg').textContent = (e && e.message) ? e.message : String(e);
      }
    };

    const bReg = $('btnRegister');
    if (bReg) bReg.onclick = async function () {
      $('msg').textContent = '';
      try {
        const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
        const cred = await m.createUserWithEmailAndPassword(auth, $('email').value, $('password').value);
        await ensureRoleDoc(cred.user.uid); /* cria role 'user' no 1º login */
      } catch (e) {
        $('msg').textContent = (e && e.message) ? e.message : String(e);
      }
    };

    const bLogout = $('btnLogout');
    if (bLogout) bLogout.addEventListener('click', async function (ev) {
      ev.preventDefault();
      try {
        const m = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
        await m.signOut(auth);
        $('status').textContent = 'Sessão encerrada.';
        setTimeout(function(){ location.reload(); }, 150);
      } catch (e) {
        $('status').textContent = 'Erro ao sair: ' + ((e && e.message) ? e.message : String(e));
      }
    });

    /* ===== Registrar batida (Entrada/Saída) ===== */
    async function doPunch(tipo) {
      var noteEl = $('note');
      var note = noteEl ? noteEl.value : '';
      var geo = null;
      var wantGeo = $('geoOpt') && $('geoOpt').checked;

      $('status').textContent = 'Registrando...';

      try {
        /* Geolocalização opcional (com timeout e alta precisão) */
        if (wantGeo && navigator.geolocation) {
          geo = await new Promise(function(resolve){
            navigator.geolocation.getCurrentPosition(
              function(pos){ resolve(pos.coords); },
              function(){ resolve(null); },
              { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
            );
          });
        }

        await addPunchSmart(tipo, note, geo); /* grava no Firestore */
        $('status').textContent = 'Ponto ' + tipo + ' registrado!';
        if (noteEl) noteEl.value = '';
      } catch (e) {
        $('status').textContent = 'Erro: ' + ((e && e.message) ? e.message : String(e));
      }

      await refreshPunches();      /* atualiza último registro visível */
      await updateDailyTotal();    /* recalcula total do dia */
    }

    const bEnt = $('btnEntrada');
    if (bEnt) bEnt.addEventListener('click', function(){ doPunch('entrada'); });

    const bSai = $('btnSaida');
    if (bSai) bSai.addEventListener('click', function(){ doPunch('saida'); });

    /* ===== Mostrar SÓ o último registro ===== */
    async function refreshPunches() {
      const list = await listRecentPunches(1); /* busca apenas 1 */
      const p = list[0];
      const ul = $('punchList'); if (!ul) return;
      ul.innerHTML = '';
      const li = document.createElement('li');

      if (!p) {
        li.textContent = 'Sem registros ainda.';
      } else {
        const d = p.ts && p.ts.toDate ? p.ts.toDate() : new Date(p.ts);
        const tipo = p.type ? ' (' + p.type + ')' : '';
        const obs  = p.note ? ' — ' + p.note : '';
        li.textContent = d.toLocaleString('pt-BR') + tipo + obs;
      }
      ul.appendChild(li);
    }

    /* ===== Total de horas do dia (pares entrada/saída) ===== */
    async function updateDailyTotal(){
      if (!auth.currentUser) return;
      const today = new Date().toISOString().slice(0,10);
      const rows = await listPunchesByDayForUser(auth.currentUser.uid, today);
      $('dailyTotal').textContent = 'Total de horas hoje: ' + msToHHMM(computeDailyMs(rows));
    }

    /* ===== Ciclo de login ===== */
    onUserChanged(async function (user) {
      show($('loggedOut'), !user);
      show($('loggedIn'),  !!user);
      $('who').textContent = user ? (user.email || '') : '';
      $('msg').textContent = '';
      $('status').textContent = '';
      if (user) {
        await ensureRoleDoc(user.uid);
        await refreshPunches();
        await updateDailyTotal();
        const admin = await isAdmin(user.uid);
        show($('adminLink'), admin);
      }
    });

    /* ===== Solicitar ajuste para o admin ===== */
    const bAdj = $('btnAdjSend');
    if (bAdj) bAdj.onclick = async function (){
      try {
        await requestAdjustment({
          dateISO: $('adjDate').value,
          timeHHMM: $('adjTime').value,
          type: $('adjType').value,
          reason: $('adjReason').value || ''
        });
        $('adjMsg').textContent = 'Pedido enviado. Aguarde aprovação.';
        $('adjReason').value = '';
      } catch (e) {
        $('adjMsg').textContent = 'Erro: ' + ((e && e.message) ? e.message : String(e));
      }
    };

    /* ===== Atalhos (E/S) — ignoram quando estiver digitando ===== */
    function isTypingTarget(el){
      if (!el) return false;
      var tag = el.tagName;
      return el.isContentEditable || tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';
    }
    window.addEventListener('keydown', function(e){
      if (!auth.currentUser) return;
      if (isTypingTarget(e.target)) return;
      var k = (e.key || '').toLowerCase();
      if (k === 'e') doPunch('entrada');
      if (k === 's') doPunch('saida');
    });
  </script>
</body>
</html>
