<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marcação de Ponto</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    button { padding: 10px 14px; border-radius: 10px; cursor: pointer; }
    input { padding: 8px; border-radius: 8px; border:1px solid #ccc; width: 100%; }
    label { display:block; margin:8px 0 4px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>Marcação de Ponto</h1>

  <div id="loggedOut" class="card">
    <h3>Entrar</h3>
    <label>Email</label>
    <input id="email" type="email" required />
    <label>Senha</label>
    <input id="password" type="password" required />
    <div class="row">
      <button id="btnLogin">Login</button>
      <button id="btnRegister">Criar conta</button>
    </div>
    <p id="msg" style="color:#b00020;"></p>
  </div>

  <div id="loggedIn" class="card hidden">
    <p>Olá, <b id="who"></b></p>
  <div class="row">
  <button id="btnEntrada">Entrada</button>
  <button id="btnSaida">Saída</button>
</div>
<label style="margin-top:8px">Observação (opcional)</label>
<input id="note" type="text" placeholder="Ex.: visita a cliente, almoço, etc." />
<p id="status"></p>
<label>Observação (opcional)</label>
<input id="note" type="text" placeholder="Ex.: visita a cliente, almoço, etc." />
    <div class="row">
      <button id="btnPunch">Bater ponto</button>
      <button id="btnLogout">Sair</button>
    </div>
    <p id="status"></p>
    <div class="card">
      <h3>Últimos registros</h3>
      <ul id="punchList"></ul>
    </div>
    <p><a href="admin.html" id="adminLink" class="hidden">Ir ao painel do Admin</a></p>
  </div>
<script type="module">
  import {
    initApp,
    auth,
    onUserChanged,
    ensureRoleDoc,
    addPunchSmart,
    listRecentPunches,
    isAdmin
  } from './app.js';

  // garante Firebase pronto
  await initApp();

  const $   = (id) => document.getElementById(id);
  const show = (el, v) => el.classList.toggle('hidden', !v);

  // -------- batida --------
  async function doPunch(tipo) {
    const note = $('note')?.value || '';
    $('status').textContent = 'Registrando...';
    try {
      await addPunchSmart(tipo, note);     // salva com type: 'entrada' | 'saida'
      $('status').textContent = `Ponto ${tipo} registrado!`;
      if ($('note')) $('note').value = '';
    } catch (e) {
      $('status').textContent = 'Erro: ' + (e?.message || e);
    }
    await refreshPunches();
  }

  // associa botões
  $('btnEntrada')?.addEventListener('click', () => doPunch('entrada'));
  $('btnSaida')?.addEventListener('click',   () => doPunch('saida'));

  // -------- lista últimos registros --------
  async function refreshPunches() {
    const punches = await listRecentPunches(10);
    const ul = $('punchList');
    if (!ul) return;
    ul.innerHTML = '';
    for (const p of punches) {
      const d = p.ts?.toDate ? p.ts.toDate() : new Date(p.ts);
      const li = document.createElement('li');
      li.textContent = `${d.toLocaleString('pt-BR')}${p.type ? ` (${p.type})` : ''}${p.note ? ' — ' + p.note : ''}`;
      ul.appendChild(li);
    }
  }

  // -------- ciclo de login --------
  onUserChanged(async (user) => {
    show($('loggedOut'), !user);
    show($('loggedIn'),  !!user);
    $('who').textContent = user?.email || '';
    $('msg').textContent = '';
    $('status').textContent = '';
    if (user) {
      await ensureRoleDoc(user.uid);           // garante role 'user' por padrão
      await refreshPunches();
      const admin = await isAdmin(user.uid);
      show($('adminLink'), admin);
    }
  });

  // (opcional) atalhos de teclado: E = entrada, S = saída
  window.addEventListener('keydown', (e) => {
    if (!auth.currentUser) return;
    if (e.key.toLowerCase() === 'e') doPunch('entrada');
    if (e.key.toLowerCase() === 's') doPunch('saida');
  });
</script>

</body>
</html>




